# SPDX-License-Identifier: PMPL-1.0
name: Publish Nixpkgs

on:
  repository_dispatch:
    types: [publish-nixpkgs]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.2)'
        required: true
      tag:
        description: 'Git tag (e.g., v1.0.2)'
        required: true

permissions: read-all

env:
  TAP_REPO: hyperpolymath/homebrew-tap

jobs:
  update-nix:
    name: Update Nix Expression in Tap
    runs-on: ubuntu-latest
    steps:
      - name: Check for TAP_GITHUB_TOKEN
        id: check-secret
        run: |
          if [ -z "${{ secrets.TAP_GITHUB_TOKEN }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::TAP_GITHUB_TOKEN not configured. Skipping Nix update."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout homebrew-tap
        if: steps.check-secret.outputs.skip != 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ secrets.TAP_GITHUB_TOKEN }}

      - name: Install Nix
        if: steps.check-secret.outputs.skip != 'true'
        uses: cachix/install-nix-action@08dcb3a5e62fa31e2da3d490afc4176ef55ecd72 # v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Get inputs
        if: steps.check-secret.outputs.skip != 'true'
        id: inputs
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Calculate source hash
        if: steps.check-secret.outputs.skip != 'true'
        id: hash
        run: |
          TAG="${{ steps.inputs.outputs.tag }}"

          # Use nix-prefetch-url to get the hash in SRI format
          HASH=$(nix-prefetch-url --unpack "https://github.com/hyperpolymath/bunsenite/archive/refs/tags/${TAG}.tar.gz" 2>/dev/null)
          SRI_HASH=$(nix hash to-sri --type sha256 "$HASH")

          echo "hash=$SRI_HASH" >> $GITHUB_OUTPUT
          echo "Calculated hash: $SRI_HASH"

      - name: Update Nix expression
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.inputs.outputs.version }}"
          TAG="${{ steps.inputs.outputs.tag }}"
          HASH="${{ steps.hash.outputs.hash }}"

          mkdir -p nix

          # Create default.nix for the package
          cat > nix/bunsenite.nix << EOF
          # SPDX-License-Identifier: PMPL-1.0
          { lib
          , rustPlatform
          , fetchFromGitHub
          }:

          rustPlatform.buildRustPackage rec {
            pname = "bunsenite";
            version = "${VERSION}";

            src = fetchFromGitHub {
              owner = "hyperpolymath";
              repo = "bunsenite";
              rev = "${TAG}";
              hash = "${HASH}";
            };

            cargoLock = {
              lockFile = "\${src}/Cargo.lock";
            };

            buildFeatures = [ "full" ];

            meta = with lib; {
              description = "Nickel configuration file parser with multi-language FFI bindings";
              homepage = "https://github.com/hyperpolymath/bunsenite";
              license = with licenses; [ mit /* Palimpsest-0.8 */ ];
              maintainers = [ ];
              mainProgram = "bunsenite";
            };
          }
          EOF

          # Create flake.nix for standalone use
          cat > nix/flake.nix << EOF
          # SPDX-License-Identifier: PMPL-1.0
          {
            description = "Bunsenite - Nickel configuration file parser with FFI bindings";

            inputs = {
              nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
              flake-utils.url = "github:numtide/flake-utils";
            };

            outputs = { self, nixpkgs, flake-utils }:
              flake-utils.lib.eachDefaultSystem (system:
                let
                  pkgs = nixpkgs.legacyPackages.\${system};
                  bunsenite = pkgs.callPackage ./bunsenite.nix { };
                in
                {
                  packages = {
                    default = bunsenite;
                    bunsenite = bunsenite;
                  };

                  apps.default = flake-utils.lib.mkApp {
                    drv = bunsenite;
                  };

                  devShells.default = pkgs.mkShell {
                    buildInputs = [ bunsenite ];
                  };
                }
              );
          }
          EOF

          # Create overlay for use in other flakes
          cat > nix/overlay.nix << EOF
          # SPDX-License-Identifier: PMPL-1.0
          final: prev: {
            bunsenite = final.callPackage ./bunsenite.nix { };
          }
          EOF

          echo "Generated Nix files:"
          cat nix/bunsenite.nix

      - name: Commit and push
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.inputs.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add nix/
          git diff --staged --quiet || git commit -m "nix: bunsenite ${VERSION}"
          git push

  create-nixpkgs-pr:
    name: Create nixpkgs PR (Optional)
    runs-on: ubuntu-latest
    needs: update-nix
    if: ${{ inputs.submit_nixpkgs == true }}
    steps:
      - name: Check for NIXPKGS_GITHUB_TOKEN
        id: check-secret
        run: |
          if [ -z "${{ secrets.NIXPKGS_GITHUB_TOKEN }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::NIXPKGS_GITHUB_TOKEN not configured. Skipping nixpkgs PR."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Create nixpkgs PR
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          echo "To submit to nixpkgs:"
          echo "1. Fork NixOS/nixpkgs"
          echo "2. Add bunsenite.nix to pkgs/by-name/bu/bunsenite/package.nix"
          echo "3. Create PR with title: bunsenite: init at ${VERSION}"
          echo ""
          echo "This requires manual review by nixpkgs maintainers."
