# SPDX-License-Identifier: PMPL-1.0
name: Publish OBS (openSUSE)

on:
  repository_dispatch:
    types: [publish-obs]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.2)'
        required: true
      tag:
        description: 'Git tag (e.g., v1.0.2)'
        required: true

permissions: read-all

env:
  TAP_REPO: hyperpolymath/homebrew-tap
  OBS_PROJECT: home:hyperpolymath
  OBS_PACKAGE: bunsenite

jobs:
  update-spec:
    name: Update OBS Spec in Tap
    runs-on: ubuntu-latest
    steps:
      - name: Check for TAP_GITHUB_TOKEN
        id: check-secret
        run: |
          if [ -z "${{ secrets.TAP_GITHUB_TOKEN }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::TAP_GITHUB_TOKEN not configured. Skipping OBS spec update."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout homebrew-tap
        if: steps.check-secret.outputs.skip != 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ secrets.TAP_GITHUB_TOKEN }}

      - name: Get inputs
        if: steps.check-secret.outputs.skip != 'true'
        id: inputs
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Update OBS spec
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.inputs.outputs.version }}"
          TAG="${{ steps.inputs.outputs.tag }}"
          DATE=$(date "+%a %b %d %Y")

          mkdir -p obs

          # Create spec file for OBS (openSUSE Build Service)
          cat > obs/bunsenite.spec << EOF
          # SPDX-License-Identifier: PMPL-1.0
          #
          # spec file for package bunsenite
          #
          # Copyright (c) 2024-2025 hyperpolymath
          #

          Name:           bunsenite
          Version:        ${VERSION}
          Release:        1%{?dist}
          Summary:        Nickel configuration file parser with multi-language FFI bindings

          License:        MIT OR Palimpsest-0.8
          URL:            https://github.com/hyperpolymath/bunsenite
          Source0:        https://github.com/hyperpolymath/bunsenite/archive/refs/tags/${TAG}.tar.gz#/bunsenite-%{version}.tar.gz

          BuildRequires:  cargo
          BuildRequires:  rust >= 1.70

          %description
          Bunsenite is a Nickel configuration file parser with multi-language FFI bindings.
          Features include parse, validate, watch mode, interactive REPL, and JSON Schema validation.

          %prep
          %autosetup -n bunsenite-%{version}

          %build
          cargo build --release --features full

          %install
          install -D -m 755 target/release/bunsenite %{buildroot}%{_bindir}/bunsenite

          %files
          %license LICENSE.txt
          %doc README.adoc
          %{_bindir}/bunsenite

          %changelog
          * ${DATE} hyperpolymath <packages@hyperpolymath.dev> - ${VERSION}-1
          - Update to version ${VERSION}
          EOF

          # Create _service file for OBS source service
          cat > obs/_service << EOF
          <services>
            <service name="obs_scm">
              <param name="url">https://github.com/hyperpolymath/bunsenite.git</param>
              <param name="scm">git</param>
              <param name="revision">${TAG}</param>
              <param name="versionformat">@PARENT_TAG@</param>
            </service>
            <service name="tar" mode="buildtime"/>
            <service name="recompress" mode="buildtime">
              <param name="compression">gz</param>
              <param name="file">*.tar</param>
            </service>
            <service name="set_version" mode="buildtime"/>
          </services>
          EOF

          echo "Generated OBS spec:"
          cat obs/bunsenite.spec

      - name: Commit and push
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.inputs.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add obs/
          git diff --staged --quiet || git commit -m "obs: bunsenite ${VERSION}"
          git push

  trigger-obs:
    name: Trigger OBS Build
    runs-on: ubuntu-latest
    needs: update-spec
    steps:
      - name: Check for OBS credentials
        id: check-secret
        run: |
          if [ -z "${{ secrets.OBS_USERNAME }}" ] || [ -z "${{ secrets.OBS_PASSWORD }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::OBS credentials not configured. Skipping OBS trigger."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install osc
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          mkdir -p ~/.config/osc
          cat > ~/.config/osc/oscrc << EOF
          [general]
          apiurl = https://api.opensuse.org

          [https://api.opensuse.org]
          user = ${{ secrets.OBS_USERNAME }}
          pass = ${{ secrets.OBS_PASSWORD }}
          EOF

      - name: Trigger rebuild
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          osc api -X POST "/trigger/runservice?project=${OBS_PROJECT}&package=${OBS_PACKAGE}" || true
          echo "OBS build triggered for ${OBS_PROJECT}/${OBS_PACKAGE}"
