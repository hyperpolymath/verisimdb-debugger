# SPDX-License-Identifier: PMPL-1.0
name: Zig FFI Build

on:
  push:
    branches: [main, master]
    paths:
      - 'zig/**'
      - 'src/ffi.rs'
      - 'Cargo.toml'
  pull_request:
    paths:
      - 'zig/**'
      - 'src/ffi.rs'
      - 'Cargo.toml'

env:
  CARGO_TERM_COLOR: always


permissions: read-all

jobs:
  build-ffi:
    name: Build FFI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            lib_ext: so
          - os: macos-latest
            lib_ext: dylib
          - os: windows-latest
            lib_ext: dll

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable
        with:
          components: rustfmt, clippy

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@abea47f85e598557f500fa1fd2ab7464fcb39406 # v2.2.1
        with:
          version: 0.11.0

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Rust library
        run: cargo build --release

      - name: Build Zig FFI layer
        working-directory: zig
        run: zig build -Doptimize=ReleaseFast

      - name: Verify FFI exports (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "=== Checking exported symbols ==="
          nm -D zig/zig-out/lib/libbunsenite.so | grep -E "parse_nickel|validate_nickel|free_string|version|rsr_tier|tpcf_perimeter" || true

      - name: Upload FFI library
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.4.3
        with:
          name: libbunsenite-${{ matrix.os }}
          path: |
            zig/zig-out/lib/libbunsenite.${{ matrix.lib_ext }}
            target/release/libbunsenite.${{ matrix.lib_ext }}

  test-ffi:
    name: Test FFI
    runs-on: ubuntu-latest
    needs: build-ffi
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@abea47f85e598557f500fa1fd2ab7464fcb39406 # v2.2.1
        with:
          version: 0.11.0

      - name: Build Rust library
        run: cargo build --release

      - name: Run Rust FFI tests
        run: cargo test ffi --release

      - name: Run Zig tests
        working-directory: zig
        run: zig build test

  test-deno-bindings:
    name: Test Deno Bindings
    runs-on: ubuntu-latest
    needs: build-ffi
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@abea47f85e598557f500fa1fd2ab7464fcb39406 # v2.2.1
        with:
          version: 0.11.0

      - name: Install Deno
        uses: denoland/setup-deno@11b63cf76cfcafb4e43f97b6cad24d8e8438f62d # v1.5.2
        with:
          deno-version: v1.x

      - name: Build FFI libraries
        run: |
          cargo build --release
          cd zig && zig build -Doptimize=ReleaseFast

      - name: Copy library for Deno
        run: cp zig/zig-out/lib/libbunsenite.so bindings/deno/

      - name: Test Deno bindings
        working-directory: bindings/deno
        run: deno run --allow-ffi --allow-read example.ts || echo "Deno test completed"
