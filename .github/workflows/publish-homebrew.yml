# SPDX-License-Identifier: PMPL-1.0
name: Publish Homebrew

on:
  repository_dispatch:
    types: [publish-homebrew]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.2)'
        required: true
      tag:
        description: 'Git tag (e.g., v1.0.2)'
        required: true
      sha_linux_x64:
        description: 'SHA256 for Linux x64'
        required: true
      sha_linux_arm64:
        description: 'SHA256 for Linux arm64'
        required: true
      sha_macos_x64:
        description: 'SHA256 for macOS x64'
        required: true
      sha_macos_arm64:
        description: 'SHA256 for macOS arm64'
        required: true

permissions: read-all

env:
  TAP_REPO: hyperpolymath/homebrew-tap

jobs:
  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    steps:
      - name: Check for TAP_GITHUB_TOKEN
        id: check-secret
        run: |
          if [ -z "${{ secrets.TAP_GITHUB_TOKEN }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::TAP_GITHUB_TOKEN not configured. Skipping Homebrew publish."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout homebrew-tap
        if: steps.check-secret.outputs.skip != 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ secrets.TAP_GITHUB_TOKEN }}

      - name: Get inputs
        if: steps.check-secret.outputs.skip != 'true'
        id: inputs
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
            echo "sha_linux_x64=${{ github.event.client_payload.sha_linux_x64 }}" >> $GITHUB_OUTPUT
            echo "sha_linux_arm64=${{ github.event.client_payload.sha_linux_arm64 }}" >> $GITHUB_OUTPUT
            echo "sha_macos_x64=${{ github.event.client_payload.sha_macos_x64 }}" >> $GITHUB_OUTPUT
            echo "sha_macos_arm64=${{ github.event.client_payload.sha_macos_arm64 }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
            echo "sha_linux_x64=${{ inputs.sha_linux_x64 }}" >> $GITHUB_OUTPUT
            echo "sha_linux_arm64=${{ inputs.sha_linux_arm64 }}" >> $GITHUB_OUTPUT
            echo "sha_macos_x64=${{ inputs.sha_macos_x64 }}" >> $GITHUB_OUTPUT
            echo "sha_macos_arm64=${{ inputs.sha_macos_arm64 }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Formula
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.inputs.outputs.version }}"
          TAG="${{ steps.inputs.outputs.tag }}"
          SHA_LINUX_X64="${{ steps.inputs.outputs.sha_linux_x64 }}"
          SHA_LINUX_ARM64="${{ steps.inputs.outputs.sha_linux_arm64 }}"
          SHA_MACOS_X64="${{ steps.inputs.outputs.sha_macos_x64 }}"
          SHA_MACOS_ARM64="${{ steps.inputs.outputs.sha_macos_arm64 }}"

          mkdir -p Formula

          cat > Formula/bunsenite.rb << 'FORMULA_EOF'
          # frozen_string_literal: true
          # SPDX-License-Identifier: PMPL-1.0

          # Homebrew formula for bunsenite
          class Bunsenite < Formula
            desc "Nickel configuration file parser with multi-language FFI bindings"
            homepage "https://github.com/hyperpolymath/bunsenite"
            license any_of: ["MIT", "LicenseRef-Palimpsest-0.8"]
          FORMULA_EOF

          cat >> Formula/bunsenite.rb << FORMULA_DYNAMIC
            version "${VERSION}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/hyperpolymath/bunsenite/releases/download/${TAG}/bunsenite-${TAG}-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_MACOS_ARM64}"
              else
                url "https://github.com/hyperpolymath/bunsenite/releases/download/${TAG}/bunsenite-${TAG}-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_MACOS_X64}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/hyperpolymath/bunsenite/releases/download/${TAG}/bunsenite-${TAG}-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_LINUX_ARM64}"
              else
                url "https://github.com/hyperpolymath/bunsenite/releases/download/${TAG}/bunsenite-${TAG}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_LINUX_X64}"
              end
            end
          FORMULA_DYNAMIC

          cat >> Formula/bunsenite.rb << 'FORMULA_EOF'

            def install
              bin.install "bunsenite"
              # Install shared library if present
              lib.install Dir["libbunsenite.*"]
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/bunsenite --version")
            end
          end
          FORMULA_EOF

          echo "Generated Formula/bunsenite.rb:"
          cat Formula/bunsenite.rb

      - name: Commit and push
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/bunsenite.rb
          git diff --staged --quiet || git commit -m "bunsenite: update to ${{ steps.inputs.outputs.tag }}"
          git push
