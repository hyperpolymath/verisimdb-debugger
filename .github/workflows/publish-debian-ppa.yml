# SPDX-License-Identifier: PMPL-1.0
name: Publish Debian PPA

on:
  repository_dispatch:
    types: [publish-debian-ppa]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.2)'
        required: true
      tag:
        description: 'Git tag (e.g., v1.0.2)'
        required: true

permissions: read-all

env:
  PPA_NAME: hyperpolymath/bunsenite
  MAINTAINER_NAME: hyperpolymath
  MAINTAINER_EMAIL: packages@hyperpolymath.dev

jobs:
  publish-ppa:
    name: Publish to Launchpad PPA
    runs-on: ubuntu-latest
    steps:
      - name: Check for Launchpad secrets
        id: check-secret
        run: |
          if [ -z "${{ secrets.LAUNCHPAD_GPG_KEY }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::LAUNCHPAD_GPG_KEY not configured. Skipping PPA publish."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout bunsenite
        if: steps.check-secret.outputs.skip != 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get inputs
        if: steps.check-secret.outputs.skip != 'true'
        id: inputs
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput gnupg

      - name: Import GPG key
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          echo "${{ secrets.LAUNCHPAD_GPG_KEY }}" | gpg --batch --import
          # Trust the key
          KEY_ID=$(gpg --list-keys --keyid-format LONG | grep -A1 "^pub" | tail -1 | awk '{print $1}')
          echo "${KEY_ID}:6:" | gpg --import-ownertrust

      - name: Download and prepare source
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.inputs.outputs.version }}"
          TAG="${{ steps.inputs.outputs.tag }}"

          # Download source tarball
          curl -L -o bunsenite_${VERSION}.orig.tar.gz \
            "https://github.com/hyperpolymath/bunsenite/archive/refs/tags/${TAG}.tar.gz"

          # Extract
          tar xzf bunsenite_${VERSION}.orig.tar.gz
          mv bunsenite-${VERSION#v} bunsenite-${VERSION}

      - name: Create debian directory
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.inputs.outputs.version }}"
          cd bunsenite-${VERSION}

          mkdir -p debian/source

          # debian/control
          cat > debian/control << EOF
          Source: bunsenite
          Section: devel
          Priority: optional
          Maintainer: ${MAINTAINER_NAME} <${MAINTAINER_EMAIL}>
          Build-Depends: debhelper-compat (= 13), cargo, rustc (>= 1.70)
          Standards-Version: 4.6.0
          Homepage: https://github.com/hyperpolymath/bunsenite
          Vcs-Browser: https://github.com/hyperpolymath/bunsenite
          Vcs-Git: https://github.com/hyperpolymath/bunsenite.git
          Rules-Requires-Root: no

          Package: bunsenite
          Architecture: any
          Depends: \${shlibs:Depends}, \${misc:Depends}
          Description: Nickel configuration file parser with FFI bindings
           Bunsenite is a Nickel configuration file parser with multi-language
           FFI bindings. Features include parse, validate, watch mode,
           interactive REPL, and JSON Schema validation.
          EOF

          # debian/rules
          cat > debian/rules << 'EOF'
          #!/usr/bin/make -f
          # SPDX-License-Identifier: PMPL-1.0

          export CARGO_HOME = $(CURDIR)/debian/cargo
          export DEB_BUILD_MAINT_OPTIONS = hardening=+all

          %:
          	dh $@

          override_dh_auto_build:
          	cargo build --release --features full

          override_dh_auto_install:
          	install -D -m 755 target/release/bunsenite debian/bunsenite/usr/bin/bunsenite

          override_dh_auto_test:
          	# Skip tests during package build
          EOF
          chmod +x debian/rules

          # debian/changelog
          DATE=$(date -R)
          cat > debian/changelog << EOF
          bunsenite (${VERSION}-1) jammy; urgency=medium

            * New upstream release ${VERSION}

           -- ${MAINTAINER_NAME} <${MAINTAINER_EMAIL}>  ${DATE}
          EOF

          # debian/copyright
          cat > debian/copyright << EOF
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: bunsenite
          Upstream-Contact: ${MAINTAINER_EMAIL}
          Source: https://github.com/hyperpolymath/bunsenite

          Files: *
          Copyright: 2024-2025 hyperpolymath
          License: MIT or Palimpsest-0.8

          License: MIT
           Permission is hereby granted, free of charge, to any person obtaining a copy
           of this software and associated documentation files (the "Software"), to deal
           in the Software without restriction, including without limitation the rights
           to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
           copies of the Software, and to permit persons to whom the Software is
           furnished to do so, subject to the following conditions:
           .
           The above copyright notice and this permission notice shall be included in all
           copies or substantial portions of the Software.
           .
           THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
           IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
           FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
           AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
           LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
           OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
           SOFTWARE.
          EOF

          # debian/source/format
          echo "3.0 (quilt)" > debian/source/format

          # debian/compat
          echo "13" > debian/compat

      - name: Build source package
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.inputs.outputs.version }}"
          cd bunsenite-${VERSION}

          # Build source package (signed)
          debuild -S -sa -k"${{ secrets.LAUNCHPAD_GPG_PASSPHRASE }}"

      - name: Upload to PPA
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.inputs.outputs.version }}"

          # Create dput config
          cat > ~/.dput.cf << EOF
          [ppa]
          fqdn = ppa.launchpad.net
          method = ftp
          incoming = ~${PPA_NAME}/ubuntu/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

          # Upload to PPA
          dput ppa bunsenite_${VERSION}-1_source.changes
