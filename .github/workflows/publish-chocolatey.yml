# SPDX-License-Identifier: PMPL-1.0
name: Publish Chocolatey

on:
  repository_dispatch:
    types: [publish-chocolatey]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.2)'
        required: true
      tag:
        description: 'Git tag (e.g., v1.0.2)'
        required: true
      sha_windows_x64:
        description: 'SHA256 for Windows x64'
        required: true

permissions: read-all

jobs:
  publish-chocolatey:
    name: Publish to Chocolatey
    runs-on: windows-latest
    steps:
      - name: Check for CHOCO_API_KEY
        id: check-secret
        shell: pwsh
        run: |
          if ([string]::IsNullOrEmpty("${{ secrets.CHOCO_API_KEY }}")) {
            echo "skip=true" >> $env:GITHUB_OUTPUT
            Write-Warning "CHOCO_API_KEY not configured. Skipping Chocolatey publish."
          } else {
            echo "skip=false" >> $env:GITHUB_OUTPUT
          }

      - name: Checkout bunsenite
        if: steps.check-secret.outputs.skip != 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get inputs
        if: steps.check-secret.outputs.skip != 'true'
        id: inputs
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "repository_dispatch") {
            echo "version=${{ github.event.client_payload.version }}" >> $env:GITHUB_OUTPUT
            echo "tag=${{ github.event.client_payload.tag }}" >> $env:GITHUB_OUTPUT
            echo "sha_windows_x64=${{ github.event.client_payload.sha_windows_x64 }}" >> $env:GITHUB_OUTPUT
          } else {
            echo "version=${{ inputs.version }}" >> $env:GITHUB_OUTPUT
            echo "tag=${{ inputs.tag }}" >> $env:GITHUB_OUTPUT
            echo "sha_windows_x64=${{ inputs.sha_windows_x64 }}" >> $env:GITHUB_OUTPUT
          }

      - name: Download Windows binary
        if: steps.check-secret.outputs.skip != 'true'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.inputs.outputs.version }}"
          $TAG = "${{ steps.inputs.outputs.tag }}"
          $URL = "https://github.com/hyperpolymath/bunsenite/releases/download/${TAG}/bunsenite-${TAG}-x86_64-pc-windows-msvc.zip"

          Write-Host "Downloading from: $URL"
          Invoke-WebRequest -Uri $URL -OutFile bunsenite.zip

          # Create tools directory
          New-Item -ItemType Directory -Force -Path packaging/chocolatey/tools
          Expand-Archive bunsenite.zip -DestinationPath packaging/chocolatey/tools -Force

      - name: Create nuspec
        if: steps.check-secret.outputs.skip != 'true'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.inputs.outputs.version }}"

          $nuspec = @"
          <?xml version="1.0" encoding="utf-8"?>
          <!-- SPDX-License-Identifier: PMPL-1.0 -->
          <package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
            <metadata>
              <id>bunsenite</id>
              <version>${VERSION}</version>
              <title>Bunsenite</title>
              <authors>hyperpolymath</authors>
              <owners>hyperpolymath</owners>
              <projectUrl>https://github.com/hyperpolymath/bunsenite</projectUrl>
              <licenseUrl>https://github.com/hyperpolymath/bunsenite/blob/main/LICENSE.txt</licenseUrl>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <projectSourceUrl>https://github.com/hyperpolymath/bunsenite</projectSourceUrl>
              <bugTrackerUrl>https://github.com/hyperpolymath/bunsenite/issues</bugTrackerUrl>
              <tags>nickel config configuration parser rust cli</tags>
              <summary>Nickel configuration file parser with multi-language FFI bindings</summary>
              <description>
          Bunsenite is a Nickel configuration file parser with multi-language FFI bindings.

          Features:
          - Parse and evaluate Nickel configuration files
          - Watch mode for live reloading
          - Interactive REPL
          - JSON Schema validation
          - FFI bindings for Deno, ReScript, and WebAssembly
              </description>
              <releaseNotes>https://github.com/hyperpolymath/bunsenite/releases/tag/v${VERSION}</releaseNotes>
            </metadata>
            <files>
              <file src="tools\**" target="tools" />
            </files>
          </package>
          "@

          Set-Content -Path packaging/chocolatey/bunsenite.nuspec -Value $nuspec
          Write-Host "Created nuspec:"
          Get-Content packaging/chocolatey/bunsenite.nuspec

      - name: Create install script
        if: steps.check-secret.outputs.skip != 'true'
        shell: pwsh
        run: |
          $installScript = @'
          $ErrorActionPreference = 'Stop'
          $toolsDir = "$(Split-Path -parent $MyInvocation.MyCommand.Definition)"
          $exePath = Join-Path $toolsDir 'bunsenite.exe'

          # Create shim
          Install-BinFile -Name 'bunsenite' -Path $exePath
          '@

          Set-Content -Path packaging/chocolatey/tools/chocolateyInstall.ps1 -Value $installScript

          $uninstallScript = @'
          $ErrorActionPreference = 'Stop'
          Uninstall-BinFile -Name 'bunsenite'
          '@

          Set-Content -Path packaging/chocolatey/tools/chocolateyUninstall.ps1 -Value $uninstallScript

      - name: Pack and push
        if: steps.check-secret.outputs.skip != 'true'
        shell: pwsh
        run: |
          cd packaging/chocolatey
          choco pack bunsenite.nuspec

          # List generated package
          Get-ChildItem *.nupkg

          # Push to Chocolatey
          choco push bunsenite.*.nupkg --source https://push.chocolatey.org/ --api-key ${{ secrets.CHOCO_API_KEY }}
